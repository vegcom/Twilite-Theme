name: Generate Theme Previews

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'twilite.json', 'twilite-darker.json' ]
  pull_request:
    branches: [ main ]
    paths: [ 'twilite.json', 'twilite-darker.json' ]

jobs:
  generate:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          activate-environment: twilite
          environment-file: environment.yml
          python-version: 3.10
      - name: Generate PNG previews
        run: python ./scripts/generate_previews.py
      - name: Commit previews
        run: |
          git config --local user.email 'action@github.com'
          git config --local user.name 'GitHub Action'
          git add assets/img/
          git status --porcelain assets/img/ | grep -q . || exit 0
          git diff --staged --quiet || git commit -m 'chore(preview): regenerate theme preview â™¡'
          git push